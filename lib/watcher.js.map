{"version":3,"sources":["../src/watcher.js"],"names":[],"mappings":"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","file":"watcher.js","sourcesContent":["import Dep from './dep'\nimport parseExpression from './expression'\nimport { pushWatcher } from './batcher'\nimport {\n  extend,\n  isArray,\n  isObject,\n} from './util'\n\nlet uid = 0\n\n/**\n * A watcher parses an expression, collects dependencies,\n * and fires callback when the expression value changes.\n * This is used for both the $watch() api and directives.\n *\n * @param {Vue} vm\n * @param {String|Function} expOrFn\n * @param {Function} cb\n * @param {Object} options\n *                 - {Boolean} twoWay\n *                 - {Boolean} deep\n *                 - {Boolean} user\n *                 - {Boolean} sync\n *                 - {Boolean} lazy\n * @constructor\n */\n\nexport default function Watcher (owner, expOrFn, cb, options) {\n  // mix in options\n  if (options) {\n    extend(this, options)\n  }\n  var isFn = typeof expOrFn === 'function'\n  this.owner = owner\n  owner._watchers.push(this)\n  this.expression = expOrFn\n  this.cb = cb\n  this.id = ++uid // uid for batching\n  this.active = true\n  this.dirty = this.lazy // for lazy watchers\n  this.deps = []\n  this.newDeps = []\n  this.depIds = Object.create(null)\n  this.newDepIds = null\n  // parse expression for getter/setter\n  if (isFn) {\n    this.getter = expOrFn\n    this.setter = undefined\n  } else {\n    var res = parseExpression(expOrFn, this.twoWay)\n    this.getter = res.get\n    this.setter = res.set\n  }\n  this.value = this.lazy\n    ? undefined\n    : this.get()\n}\n\n/**\n * Evaluate the getter, and re-collect dependencies.\n */\n\nWatcher.prototype.get = function () {\n  this.beforeGet()\n  var scope = this.owner\n  var value = this.getter.call(scope, scope)\n  if (this.deep) {\n    traverse(value)\n  }\n  this.afterGet()\n  return value\n}\n\n/**\n * Set the corresponding value with the setter.\n *\n * @param {*} value\n */\n\nWatcher.prototype.set = function (value) {\n  var scope = this.owner\n  this.setter.call(scope, scope, value)\n}\n\n/**\n * Prepare for dependency collection.\n */\n\nWatcher.prototype.beforeGet = function () {\n  Dep.target = this\n  this.newDepIds = Object.create(null)\n  this.newDeps.length = 0\n}\n\n/**\n * Add a dependency to this directive.\n *\n * @param {Dep} dep\n */\n\nWatcher.prototype.addDep = function (dep) {\n  var id = dep.id\n  if (!this.newDepIds[id]) {\n    this.newDepIds[id] = true\n    this.newDeps.push(dep)\n    if (!this.depIds[id]) {\n      dep.addSub(this)\n    }\n  }\n}\n\n/**\n * Clean up for dependency collection.\n */\n\nWatcher.prototype.afterGet = function () {\n  Dep.target = null\n  var i = this.deps.length\n  while (i--) {\n    var dep = this.deps[i]\n    if (!this.newDepIds[dep.id]) {\n      dep.removeSub(this)\n    }\n  }\n  this.depIds = this.newDepIds\n  var tmp = this.deps\n  this.deps = this.newDeps\n  this.newDeps = tmp\n}\n\n/**\n * Subscriber interface.\n * Will be called when a dependency changes.\n *\n * @param {Boolean} shallow\n */\n\nWatcher.prototype.update = function (shallow) {\n  if (this.lazy) {\n    this.dirty = true\n  } else if (this.sync) {\n    this.run()\n  } else {\n    pushWatcher(this)\n  }\n}\n\n/**\n * Batcher job interface.\n * Will be called by the batcher.\n */\n\nWatcher.prototype.run = function () {\n  if (this.active) {\n    var value = this.get()\n    if (\n      value !== this.value ||\n      // Deep watchers and watchers on Object/Arrays should fire even when\n      // the value is the same, because the value may have mutated;\n      ((isObject(value) || this.deep))\n    ) {\n      // set new value\n      var oldValue = this.value\n      this.value = value\n      // in debug + async mode, when a watcher callbacks\n      // throws, we also throw the saved before-push error\n      // so the full cross-tick stack trace is available.\n      this.cb.call(this.owner, value, oldValue)\n    }\n  }\n}\n\n/**\n * Evaluate the value of the watcher.\n * This only gets called for lazy watchers.\n */\n\nWatcher.prototype.evaluate = function () {\n  // avoid overwriting another watcher that is being\n  // collected.\n  var current = Dep.target\n  this.value = this.get()\n  this.dirty = false\n  Dep.target = current\n}\n\n/**\n * Depend on all deps collected by this watcher.\n */\n\nWatcher.prototype.depend = function () {\n  var i = this.deps.length\n  while (i--) {\n    this.deps[i].depend()\n  }\n}\n\n/**\n * Remove self from all dependencies' subcriber list.\n */\n\nWatcher.prototype.teardown = function () {\n  if (this.active) {\n    var i = this.deps.length\n    while (i--) {\n      this.deps[i].removeSub(this)\n    }\n    this.active = false\n    this.owner = this.cb = this.value = null\n  }\n}\n\n/**\n * Recrusively traverse an object to evoke all converted\n * getters, so that every nested property inside the object\n * is collected as a \"deep\" dependency.\n *\n * @param {*} val\n */\n\nfunction traverse (val) {\n  var i, keys\n  if (isArray(val)) {\n    i = val.length\n    while (i--) traverse(val[i])\n  } else if (isObject(val)) {\n    keys = Object.keys(val)\n    i = keys.length\n    while (i--) traverse(val[keys[i]])\n  }\n}\n"]}